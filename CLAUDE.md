# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

If the user's prompt starts with ‚ÄúEP:‚Äù, then the user wants to enhance the prompt. Read the PROMPT_ENHANCER.md file and follow the guidelines to enhance the user's prompt. Show the user the enhancement and get their permission to run it before taking action on the enhanced prompt.

The enhanced prompts will follow the language of the original prompt (e.g., Korean prompt input will output Korean prompt enhancements, English prompt input will output English prompt enhancements, etc.)

## Principal

**üö´ CRITICAL: Git Commit Messages - NO AI BRANDING:**
- **NEVER** add AI assistant branding, attribution, links, or signatures to commit messages
- **NEVER** add footer lines with "Generated by", "Co-Authored-By", or similar attribution
- Commit messages must contain ONLY the actual change description
- Keep commits clean and professional without any automated signatures

**Package Manager Support**: This project supports **npm, pnpm, yarn, and bun**. All commands in this document use `pnpm` as the default, but you can substitute with your preferred package manager:
- `pnpm <command>` ‚Üí `npm run <command>` or `yarn <command>` or `bun run <command>`
- The build system automatically detects your package manager via `scripts/run-with-pm.cjs`

**Design Principles:**
- Pursue highly readable design
- Pursue highly predictable design
- Pursue high cohesion design
- Pursue low coupling design

**Naming Conventions (CRITICAL):**
- **NEVER name a file and folder identically in the same directory**
  - ‚ùå BAD: `src/i18n.ts` + `src/i18n/index.ts` (module resolution ambiguity)
  - ‚úÖ GOOD: `src/i18n.config.ts` + `src/i18n/` (clear and unambiguous)
- Use descriptive suffixes for configuration files (`.config.ts`, `.setup.ts`, etc.)
- This prevents module resolution conflicts where `import "./name"` could resolve to either:
  - `./name.ts` (file)
  - `./name/index.ts` (folder index)
- Lesson learned: We had two i18n config files and spent hours debugging why translations weren't loading

**‚ö†Ô∏è Platform Note**: This application is officially tested and supported on **macOS only**. Windows and Linux builds may compile but functionality is not guaranteed. See "Platform and Deployment" section for details.

## Project Overview

Claude Code History Viewer is a Tauri-based desktop application that allows users to browse and analyze their Claude Code conversation history stored in the `~/.claude` directory.

## Development Commands

### Building and Running
- `pnpm dev` - Start Vite dev server for frontend development
- `pnpm tauri:dev` - Run full Tauri application in development mode
- `pnpm build` - Build frontend with TypeScript checking and version sync
- `pnpm tauri:build` - Build production desktop application for current platform
- `pnpm tauri:build:mac` - Build production application for macOS (universal binary)
- `pnpm tauri:build:windows` - Build production application for Windows (x86_64)
- `pnpm tauri:build:linux` - Build production application for Linux (x86_64)
- `pnpm sync-version` - Sync version between package.json and tauri.conf.json

### Testing
- `pnpm test` - Run unit tests in watch mode (Vitest)
- `pnpm test:run` - Run unit tests once with verbose output
- `pnpm test:ui` - Run unit tests with Vitest UI
- `pnpm test:simple` - Run simple test suite
- `pnpm test:e2e` - Run E2E tests with Playwright
- `pnpm test:e2e:ui` - Run E2E tests in interactive UI mode
- `pnpm test:e2e:headed` - Run E2E tests with visible browser
- `pnpm test:e2e:debug` - Run E2E tests with debugger
- `pnpm test:e2e:report` - Show E2E test report
- `pnpm test:all` - Run all tests (unit + E2E)

### Code Quality
- `pnpm lint` - Run ESLint on the codebase

### Release Management
- `pnpm release <version>` - **Create a new release** (updates versions, commits, tags)
  - Example: `pnpm release 1.0.8`
  - Automatically updates `package.json`, `Cargo.toml`, and `tauri.conf.json`
  - Creates git commit and tag
  - See "Release Process" section for full workflow
- `pnpm sync-version` - Manually sync version from package.json to other files (rarely needed)

## Platform Support

This application is **fully cross-platform** and runs on:
- ‚úÖ **Windows** (x86_64) - `.exe` installer via NSIS, `.msi` via WiX
- ‚úÖ **macOS** (Universal binary for Intel + Apple Silicon) - `.dmg`, `.app`
- ‚úÖ **Linux** (x86_64) - `.deb`, `.AppImage`, `.rpm`

### macOS-Specific Notes

On macOS, the application:
- Automatically detects the `.claude` folder in the user's home directory (`~/.claude`)
- Uses native WebKit for rendering (built into macOS)
- Supports both Intel and Apple Silicon (M1/M2/M3) via universal binary
- Bundled as `.dmg` (disk image) and `.app` (application bundle)
- Code signing and notarization supported (requires Apple Developer account)

### Building for macOS

**Prerequisites:**
- Xcode Command Line Tools: `xcode-select --install`
- Rust toolchain with both architectures (for universal binary)

**Build command:**
```bash
pnpm tauri:build:mac
```

This creates a **universal binary** that runs on both Intel and Apple Silicon Macs.

Build artifacts will be in `src-tauri/target/release/bundle/`:
- `dmg/` - Disk image installer (.dmg)
- `macos/` - Application bundle (.app)

**Installing:**
Simply drag the `.app` from the `.dmg` to your Applications folder.

### Windows-Specific Notes

On Windows, the application:
- Automatically detects the `.claude` folder in the user's home directory (`C:\Users\<username>\.claude`)
- Uses the Windows WebView2 runtime (automatically downloaded if not present)
- Supports Korean and English languages in the installer
- Creates an uninstaller for easy removal
- Bundled as both NSIS installer (`.exe`) and WiX installer (`.msi`)

### Building for Windows

To build on Windows:
```bash
pnpm tauri:build:windows
```

Build artifacts will be in `src-tauri/target/release/bundle/`:
- `nsis/` - NSIS installer (.exe)
- `msi/` - WiX installer (.msi)

### Linux-Specific Notes

On Linux, the application:
- Automatically detects the `.claude` folder in the user's home directory (`~/.claude`)
- Uses the system's WebKitGTK for rendering (ensure it's installed)
- Supports both GTK-based desktop environments (GNOME, XFCE, etc.)
- Bundled as `.deb` (Debian/Ubuntu), `.AppImage` (universal), and `.rpm` (Fedora/RHEL)

### Building for Linux

**Prerequisites:**
```bash
# Debian/Ubuntu
sudo apt update
sudo apt install libwebkit2gtk-4.1-dev \
  build-essential \
  curl \
  wget \
  file \
  libxdo-dev \
  libssl-dev \
  libayatana-appindicator3-dev \
  librsvg2-dev

# Fedora
sudo dnf install webkit2gtk4.1-devel \
  openssl-devel \
  curl \
  wget \
  file \
  libappindicator-gtk3-devel \
  librsvg2-devel

# Arch Linux
sudo pacman -S webkit2gtk-4.1 \
  base-devel \
  curl \
  wget \
  file \
  openssl \
  appmenu-gtk-module \
  gtk3 \
  libappindicator-gtk3 \
  librsvg \
  libvips
```

**Build command:**
```bash
pnpm tauri:build:linux
```

Build artifacts will be in `src-tauri/target/release/bundle/`:
- `deb/` - Debian package (.deb) for Ubuntu/Debian
- `appimage/` - Universal Linux binary (.AppImage)
- `rpm/` - RPM package for Fedora/RHEL (if rpmbuild is installed)

**Installing:**
```bash
# For .deb (Ubuntu/Debian)
sudo dpkg -i src-tauri/target/release/bundle/deb/*.deb

# For .AppImage (any distro)
chmod +x *.AppImage
./claude-code-history-viewer*.AppImage

# For .rpm (Fedora/RHEL)
sudo rpm -i src-tauri/target/release/bundle/rpm/*.rpm
```

## Architecture

### Universal Message Architecture (v2.0 - Multi-Provider Support)

**Overview**: The application uses a provider-agnostic architecture that supports multiple AI coding assistants (Claude Code, Cursor IDE, etc.) through a unified data model.

#### Three-Tier Type System

The architecture uses three distinct type layers to maintain clear separation of concerns:

1. **Provider-Specific Types** (e.g., `RawClaudeMessage`, Cursor SQLite schema)
   - Raw data formats from each AI assistant
   - Located in provider adapters
   - Never exposed to UI layer

2. **UniversalMessage** (Provider-Agnostic)
   - Common format returned by backend Rust adapters
   - Defined in `src/types/universal.ts`
   - Includes normalized fields that work across all providers:
     - `id`, `parent_id`, `session_id`, `timestamp`
     - `role` ("user" | "assistant" | "system")
     - `content` (text, tool_use, tool_result, thinking)
     - `metadata` (tokens, model, provider info)

3. **UIMessage** (UI Display Format)
   - Frontend display format with UI-friendly field names
   - Defined in `src/types/index.ts`
   - Converted from UniversalMessage by frontend adapters
   - Used by all React components

#### Data Flow Diagram

```
Provider Data (JSONL, SQLite, etc.)
         ‚Üì
Backend Rust Adapter (src-tauri/src/commands/adapters/)
  - Reads files/databases
  - Parses provider-specific formats
  - Converts to UniversalMessage
         ‚Üì
UniversalMessage (sent via Tauri IPC)
         ‚Üì
Frontend Adapter (src/adapters/providers/)
  - Receives UniversalMessage
  - Converts to UIMessage
  - Handles errors, retries, caching
         ‚Üì
Zustand Store (src/store/useAppStore.ts)
         ‚Üì
UI Components (React)
```

#### Why Two Adapter Layers?

**Backend Adapters (Rust)**:
- Heavy file I/O and parsing
- Provider-specific data extraction
- Performance-critical operations
- Convert to UniversalMessage format

**Frontend Adapters (TypeScript)**:
- UniversalMessage ‚Üí UIMessage conversion
- Error handling and retry logic
- Client-side caching (future)
- Offline mode support (future)
- Legacy response format handling

#### Provider Support

Currently supported providers:
- ‚úÖ **Claude Code** - JSONL files in `~/.claude/projects/`
- ‚úÖ **Cursor IDE** - SQLite database in `AppData/Roaming/Cursor/`

Adding new providers requires:
1. Backend Rust adapter implementing `ProviderAdapter` trait
2. Frontend TypeScript adapter extending `BaseProviderAdapter`
3. Add to `src-tauri/src/commands/source_manager.rs`
4. Add translations for provider name in i18n files

### Frontend (React + TypeScript)

- **State Management**: Uses Zustand store in `src/store/useAppStore.ts`
  - Main application state, project/session/message data
  - Analytics state (token stats, activity heatmaps)
  - Pagination state for infinite scrolling
  - Language preferences in `src/store/useLanguageStore.ts`

- **Internationalization (i18n)**:
  - **Configuration**: `src/i18n.config.ts` - Single source of truth for i18n setup
    - ‚ö†Ô∏è **IMPORTANT**: Named `.config.ts` to avoid collision with `src/i18n/` folder
    - Supports 6 languages: English, Korean, Japanese, Simplified Chinese, Traditional Chinese, Russian
    - Namespaces: `common`, `components`, `messages`, `sourceManager`, `splash`, `search`
  - **Translation files**: `src/i18n/locales/{lang}/{namespace}.json`
  - **Never** create `src/i18n/index.ts` - it will conflict with the config file!

- **Component Organization**:
  - `src/components/` - Core UI components
    - `MessageViewer.tsx` - Main message display with virtual scrolling
    - `ProjectTree.tsx` - Project/session tree navigation
    - `AnalyticsDashboard.tsx` - Activity heatmaps and statistics
    - `TokenStatsViewer.tsx` - Token usage visualization
  - `src/components/contentRenderer/` - Content type renderers
    - `ClaudeContentArrayRenderer.tsx` - Array content rendering
    - `ThinkingRenderer.tsx` - Claude thinking blocks
    - `CommandRenderer.tsx` - Slash command display
  - `src/components/messageRenderer/` - Message component renderers
    - `MessageContentDisplay.tsx` - Main message content router
    - `ClaudeToolUseDisplay.tsx` - Tool use visualization
    - `AssistantMessageDetails.tsx` - Token usage and metadata
  - `src/components/toolResultRenderer/` - Tool result visualizations
    - `WebSearchRenderer.tsx` - Web search results
    - `FileEditRenderer.tsx` - File edit diffs
    - `GitWorkflowRenderer.tsx` - Git operations
    - `TodoUpdateRenderer.tsx` - Todo list changes
    - `TerminalStreamRenderer.tsx` - Terminal output
  - `src/components/modals/` - Modal dialogs
  - `src/components/ui/` - Radix UI wrapper components

- **Internationalization**:
  - Uses i18next with react-i18next
  - Supports: English, Korean, Japanese, Simplified Chinese, Traditional Chinese
  - Language files in `src/i18n/locales/{lang}/`
  - Auto-detection with localStorage persistence

- **Theme System**:
  - Context-based theme provider in `src/contexts/theme/`
  - Supports light/dark mode with system preference detection

- **API Integration**:
  - Frontend communicates with Rust backend via Tauri's IPC commands using `@tauri-apps/api/core`
  - All commands are async and return `Result<T, String>` from Rust

- **Virtual Scrolling**:
  - Uses `@tanstack/react-virtual` for efficient rendering
  - Paginated message loading (20 messages initial, load more on scroll)
  - Dynamic height calculation for variable content

### Backend (Rust + Tauri)

- **Command Organization** (in `src-tauri/src/commands/`):
  - `project.rs` - Project discovery and validation
    - `get_claude_folder_path` - Locates user's `.claude` directory
    - `validate_claude_folder` - Validates Claude folder structure
    - `scan_projects` - Scans for all Claude projects
  - `session.rs` - Session and message management
    - `load_project_sessions` - Loads sessions for a specific project
    - `load_session_messages_paginated` - Paginated message loading
    - `get_session_message_count` - Get total message count
    - `search_messages` - Full-text message search
  - `stats.rs` - Analytics and statistics
    - `get_session_token_stats` - Session-level token usage
    - `get_project_token_stats` - Project-level token aggregation
    - `get_project_stats_summary` - Activity heatmaps and tool usage
    - `get_session_comparison` - Session ranking and percentiles
  - `update.rs` & `secure_update.rs` - Update checking and verification
    - `check_for_updates` - Check GitHub releases
    - `check_for_updates_secure` - Verify update metadata
    - `verify_download_integrity` - SHA-256 checksum validation
  - `feedback.rs` - User feedback
    - `send_feedback` - Collect and store user feedback
    - `get_system_info` - System information for bug reports
    - `open_github_issues` - Open GitHub issues page

- **Data Models** (in `src-tauri/src/models.rs`):
  - Rust structs mirror TypeScript interfaces in `src/types/index.ts` and `src/types/universal.ts`
  - All structs use `serde` for serialization/deserialization
  - `UniversalMessage` is the primary interchange format
  - Provider-specific structs (e.g., `RawClaudeMessage`) used only in adapters

- **Provider Adapters** (in `src-tauri/src/commands/adapters/`):
  - `claude_code.rs` - Reads JSONL files from `~/.claude/projects/`
  - `cursor.rs` - Reads SQLite database from Cursor IDE
  - Each adapter implements unified interface returning `UniversalMessage`
  - Handles provider-specific parsing, filtering, and normalization

- **Data Flow** (Universal Architecture):
  - Provider adapter reads data source (JSONL, SQLite, etc.)
  - Parses provider-specific format (e.g., `RawClaudeMessage`)
  - Converts to `UniversalMessage` with normalized fields
  - Filters (exclude sidechain), sorts, and paginates
  - Serializes to JSON and sends to frontend via Tauri IPC
  - Frontend adapter converts `UniversalMessage` ‚Üí `UIMessage` for display

## Raw Message Structure

The application reads `.jsonl` files where each line is a JSON object representing a single message. The core structure is as follows:

```json
{
  "uuid": "...",
  "parentUuid": "...",
  "sessionId": "...",
  "timestamp": "...",
  "type": "user" | "assistant" | "system" | "summary",
  "message": { ... },
  "toolUse": { ... },
  "toolUseResult": { ... },
  "isSidechain": false
}
```

### The `message` Field

The `message` field is a nested JSON object. Its structure varies depending on the message `type`.

**For `user` messages:**

```json
{
  "message": {
    "role": "user",
    "content": "..." // or ContentItem[]
  }
}
```

**For `assistant` messages:**

Assistant messages contain additional metadata within the `message` object:

```json
{
  "message": {
    "id": "msg_...",
    "role": "assistant",
    "model": "claude-opus-4-20250514",
    "content": [...],
    "stop_reason": "tool_use" | "end_turn" | null,
    "usage": {
      "input_tokens": 123,
      "output_tokens": 456,
      "cache_creation_input_tokens": 20238,
      "cache_read_input_tokens": 0,
      "service_tier": "standard"
    }
  }
}
```

- **`id`, `model`, `stop_reason`, `usage`**: These fields are typically present only in assistant messages.
- **`usage` object**: Contains detailed token counts, including cache-related metrics.

## Key Implementation Details

### Data Flow and State Management
- The app expects Claude conversation data in `~/.claude/projects/[project-name]/*.jsonl`
- Each JSONL file represents a session with one JSON message per line
- Messages can contain tool use results and error information
- Initial page size is 20 messages for fast loading, then paginated on scroll
- Sidechain messages can be filtered out via `excludeSidechain` flag
- Message tree structure is flattened for virtual scrolling while preserving parent-child relationships

### Performance Optimizations
- Virtual scrolling with `@tanstack/react-virtual` for large message lists
- Message components are memoized to prevent unnecessary re-renders
- Dynamic height calculation and caching for variable content sizes
- Paginated loading to avoid loading entire sessions at once
- Zustand state management for efficient re-renders

### UI and Styling
- Tailwind CSS v4 with custom Claude brand colors
- Supports light/dark themes with system preference detection
- Multilingual UI (English, Korean, Japanese, Simplified/Traditional Chinese)
- Radix UI components for accessible dialogs, dropdowns, and tooltips
- Syntax highlighting with Prism for code blocks

### Update System
- Auto-update checking via GitHub releases
- SHA-256 checksum verification for download integrity
- Supports force updates with deadline enforcement
- Update metadata includes priority levels (critical/recommended/optional)
- Update consent modal with user preferences stored in Tauri Store

## Important Patterns

### Rust Backend
- All Tauri commands are async and return `Result<T, String>`
- Commands use absolute file paths (never relative)
- Error messages include type prefix for frontend parsing (e.g., `CLAUDE_FOLDER_NOT_FOUND:`)
- Serde is used for all serialization/deserialization
- JSONL parsing handles both string and array content types

### Frontend
- Components use `invoke` from `@tauri-apps/api/core` for backend calls
- State updates should trigger appropriate loading states
- Message adapters normalize data between Rust structs and frontend types
- i18next translation keys use namespace pattern: `namespace:key`
- Theme changes propagate via React Context

### Testing

**Unit Tests (Vitest)**
- Vitest for unit tests with jsdom environment
- Testing library for React component tests
- Configuration in `vite.config.ts` (lines 129-139)
- Currently minimal test coverage

**E2E Tests (Playwright)**
- Playwright tests for full application behavioral testing
- Tests Tauri app via WebView2 + Chrome DevTools Protocol (CDP)
- Test files in `e2e/tests/` directory
- Configuration in `playwright.config.ts`
- Fixtures:
  - `e2e/fixtures/tauri.ts` - Launches Tauri with debugging port, connects Playwright
  - `e2e/fixtures/mockClaudeData.ts` - Generates mock Claude conversation data
- Test Suites:
  - `app-initialization.spec.ts` - App startup, loading states, error handling
  - `navigation.spec.ts` - Project/session navigation, view switching
  - `ui-interactions.spec.ts` - Theme, language, settings, keyboard nav
- **Platform**: Currently supports Windows only (WebView2 required)
- **Setup**: Requires `WEBVIEW2_ADDITIONAL_BROWSER_ARGUMENTS=--remote-debugging-port=9222`
- **Documentation**: See `e2e/README.md` for detailed setup and usage

## Missing Features and Implementation Gaps

### ‚ö†Ô∏è Search Functionality (Backend Ready, UI Missing)

**Current State:**
- ‚úÖ **Backend**: Fully implemented in `src-tauri/src/commands/session.rs:558-613`
  - `search_messages` command searches across ALL projects in `~/.claude/projects/`
  - Case-insensitive string matching in message content
  - Returns full message objects with metadata (uuid, timestamp, content, etc.)
- ‚úÖ **Frontend Store**: Ready to use in `src/store/useAppStore.ts:324-344`
  - `searchMessages()` action invokes backend command
  - State includes `searchQuery`, `searchResults`, `searchFilters`
  - `SearchFilters` interface defined in `src/types/index.ts:128-135`
- ‚ùå **UI Components**: Completely missing
  - No search bar in Header or anywhere else
  - No search results display component
  - No way for users to trigger search functionality
  - README claims "Search and filter" feature exists, but UI is not implemented

**Implementation Path for Future Development:**
1. Add search input to Header component (with icon button)
2. Create `SearchResults.tsx` component to display matches
   - Show which project/session each result is from
   - Allow clicking result to jump to that session
   - Highlight search terms in results
3. Add search filters UI (date range, project selector, message type)
4. Wire search input to `useAppStore().searchMessages()`
5. Display results in main content area or modal

**Backend Search Capabilities:**
- Searches through all JSONL files in `~/.claude/projects/`
- Matches against both user and assistant message content
- Supports string content and array content types
- Returns results with full context (session ID, project, timestamp)

### Navigation and Discovery

**Current Session Visibility:**
- ‚úÖ Sessions are visible in `ProjectTree` component when project is expanded
- ‚úÖ Sessions sorted by `last_modified` (newest first)
- ‚úÖ Each session displays:
  - Summary (from summary message or first user message)
  - Message count
  - Last modified time (relative: "2 hours ago", "3 days ago", etc.)
  - Tool usage indicator (wrench icon)
  - Error indicator (warning icon)
  - Session ID (truncated, first 8 chars)

**Missing Navigation Features:**
- ‚ùå No search/filter within ProjectTree
- ‚ùå No sorting options (currently fixed to last_modified descending)
- ‚ùå No recently viewed sessions list
- ‚ùå No favorites/bookmarks functionality
- ‚ùå No session grouping or categorization
- ‚ùå No quick jump to session by ID

## Claude Directory Structure Analysis

### Directory Structure

```text
~/.claude/
‚îú‚îÄ‚îÄ projects/          # Contains project-specific conversation data
‚îÇ   ‚îî‚îÄ‚îÄ [project-name]/
‚îÇ       ‚îî‚îÄ‚îÄ *.jsonl    # JSONL files with conversation messages
‚îú‚îÄ‚îÄ ide/              # IDE-related data
‚îú‚îÄ‚îÄ statsig/          # Statistics/analytics data
‚îî‚îÄ‚îÄ todos/            # Todo list data
```

### JSONL Message Format

Each JSONL file contains one JSON object per line. The actual structure differs from what the frontend expects:

#### Raw Message Structure (in JSONL files)

This is the corrected structure based on analysis of the `.jsonl` files.

```json
{
  "uuid": "unique-message-id",
  "parentUuid": "uuid-of-parent-message",
  "sessionId": "session-uuid",
  "timestamp": "2025-06-26T11:45:51.979Z",
  "type": "user | assistant | system | summary",
  "isSidechain": false,
  "cwd": "/path/to/working/directory",
  "version": "1.0.35",
  "requestId": "request-id-from-assistant",
  "userType": "external",
  "message": {
    "role": "user | assistant",
    "content": "..." | [],
    "id": "msg_...",
    "model": "claude-opus-4-20250514",
    "stop_reason": "tool_use",
    "usage": { "input_tokens": 123, "output_tokens": 456 }
  },
  "toolUse": {},
  "toolUseResult": "..." | {}
}
```

**Note:** The fields `parentUuid`, `isSidechain`, `cwd`, `version`, `requestId`, `userType`, `toolUse`, `toolUseResult` are optional. The fields `id`, `model`, `stop_reason`, `usage` are specific to assistant messages and are also optional.

### Content Types

#### 1. User Message Content Types

**Simple String Content**

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "Îçî Í≥†ÎèÑÌôîÌï† Î∂ÄÎ∂ÑÏùÄ ÏóÜÏùÑÍπå?"
  }
}
```

**Array Content with tool_result**

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [
      {
        "tool_use_id": "toolu_01VDVUHPae8mbcpER7tbbHvd",
        "type": "tool_result",
        "content": "file content here..."
      }
    ]
  }
}
```

**Array Content with text type**

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": [
      {
        "type": "text",
        "text": "Please analyze this codebase..."
      }
    ]
  }
}
```

**Command Messages**

```json
{
  "type": "user",
  "message": {
    "role": "user",
    "content": "<command-message>init is analyzing your codebase‚Ä¶</command-message>\n<command-name>/init</command-name>"
  }
}
```

#### 2. Assistant Message Content Types

**Text Content**

```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [
      {
        "type": "text",
        "text": "I'll help you fix these Rust compilation errors..."
      }
    ]
  }
}
```

**Tool Use Content**

```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [
      {
        "type": "tool_use",
        "id": "toolu_01QUa384MpVwU4F8tuF8hg9T",
        "name": "TodoWrite",
        "input": {
          "todos": [...]
        }
      }
    ]
  }
}
```

**Thinking Content**

```json
{
  "type": "assistant",
  "message": {
    "role": "assistant",
    "content": [
      {
        "type": "thinking",
        "thinking": "ÏÇ¨Ïö©ÏûêÍ∞Ä Î©îÏãúÏßÄ Í∞ùÏ≤¥Ïùò ÎÇ¥Ïö©Ïù¥ nullÏù¥Í≥†...",
        "signature": "EpUICkYIBRgCKkCB6bsN5FuO+M1gLbr..."
      }
    ]
  }
}
```

#### 3. Tool Use Result Structures

**File Read Results**

```json
{
  "toolUseResult": {
    "type": "text",
    "file": {
      "filePath": "/Users/jack/client/ai-code-tracker/package.json",
      "content": "{\n  \"name\": \"ai-code-tracker\"...",
      "numLines": 59,
      "startLine": 1,
      "totalLines": 59
    }
  }
}
```

**Command Execution Results**

```json
{
  "toolUseResult": {
    "stdout": "> ai-code-tracker@0.6.0 lint\n> eslint src --fix",
    "stderr": "",
    "interrupted": false,
    "isImage": false
  }
}
```

**Error Results**

```json
{
  "message": {
    "content": [
      {
        "type": "tool_result",
        "content": "Error: The service was stopped\n    at ...",
        "is_error": true,
        "tool_use_id": "toolu_01PKwT3i8u1ryjWZpMBWmDjX"
      }
    ]
  }
}
```

**Todo List Results**

```json
{
  "toolUseResult": {
    "oldTodos": [...],
    "newTodos": [...]
  }
}
```

**Multi-Edit Results**

```json
{
  "toolUseResult": {
    "filePath": "/Users/jack/client/ai-code-tracker/src/extension.ts",
    "edits": [
      {
        "old_string": "...",
        "new_string": "...",
        "replace_all": false
      }
    ],
    "originalFileContents": "..."
  }
}
```

#### 4. Special Message Types

**Summary Messages**

```json
{
  "type": "summary",
  "summary": "AI Code Tracker: Comprehensive VS Code Extension Analysis",
  "leafUuid": "28f1d1f6-3485-48a6-9408-723624bc1e42"
}
```

### Message Metadata Fields

- `parentUuid`: Links to parent message in conversation tree
- `isSidechain`: Boolean indicating if this is a sidechain conversation
- `userType`: Usually "external" for user messages
- `cwd`: Current working directory when message was sent
- `sessionId`: Unique session identifier
- `version`: Claude client version
- `timestamp`: ISO 8601 timestamp
- `uuid`: Unique message identifier
- `requestId`: Present in assistant messages

### Content Rendering Status

Currently Supported:

- ‚úÖ Text content (`type: "text"`)
- ‚úÖ Tool use (`type: "tool_use"`)
- ‚úÖ Tool results (`type: "tool_result`)
- ‚úÖ Command messages (within text content)

Not Yet Supported:

- ‚ùå Thinking type (`type: "thinking`) - currently only supported as text tags
- ‚ùå Image content - structure supports it via `isImage` flag but no rendering logic

## Platform and Deployment

### Current Platform Support
- **macOS**: Primary and officially supported platform
  - Universal binary (Apple Silicon + Intel)
  - Minimum version: 10.13 (High Sierra)
  - Fully tested and production-ready

- **Windows**: Experimental/Untested
  - Build configuration exists (Tauri is cross-platform)
  - **NOT officially tested or supported**
  - May work but expect issues:
    - Path handling differences (`~/.claude` vs Windows paths)
    - File system permissions
    - Auto-updater may not work
    - UI rendering differences
  - Community testing and contributions welcome

- **Linux**: Planned but not yet implemented
  - Build targets not configured
  - No testing or packaging for Linux distributions

### Build Configuration
- Tauri v2 with auto-updater plugin enabled
- Update signature verification via minisign
- GitHub Actions workflow for automated releases
- Version syncing between `package.json` and `tauri.conf.json`
- Rollup bundle analyzer for optimization insights

### Release Process

**IMPORTANT: Always use the `release` script for creating new releases. Do not manually update version files.**

#### Automated Release Workflow

1. **Run the release script** with the new version number:
   ```bash
   # Using pnpm (or npm/yarn/bun - all supported)
   pnpm release 1.0.8
   # npm run release 1.0.8
   # yarn release 1.0.8
   # bun run release 1.0.8
   ```

   This script (`scripts/release.cjs`) automatically:
   - Updates version in `package.json`
   - Updates version in `src-tauri/Cargo.toml`
   - Updates version in `src-tauri/tauri.conf.json`
   - Creates a git commit: `chore: bump version to X.X.X`
   - Creates a git tag: `vX.X.X`
   - Provides push instructions

2. **Push to GitHub** to trigger automated builds:
   ```bash
   git push origin main && git push origin vX.X.X
   ```

3. **GitHub Actions automatically**:
   - Creates GitHub Release with the tag
   - Builds for all platforms (macOS, Windows, Linux)
   - Uploads signed binaries (.dmg, .msi, .AppImage)
   - Generates `latest.json` for Tauri auto-updater

4. **Auto-updater** checks release metadata from `latest.json` and notifies users

#### Release Script Details

The `release` script is the **correct and complete** way to create releases (works with all package managers):

```bash
# Usage (choose your package manager)
pnpm release <version>      # pnpm
npm run release <version>   # npm
yarn release <version>      # yarn
bun run release <version>   # bun

# Example
pnpm release 1.0.8

# Skip git operations (for testing)
pnpm release 1.0.8 --no-git
```

**What it does:**
- ‚úÖ Synchronizes version across all 3 files
- ‚úÖ Creates standardized commit message
- ‚úÖ Creates properly formatted git tag
- ‚úÖ Validates semver format (major.minor.patch)

**What it does NOT do (intentionally):**
- ‚ùå Does NOT push automatically (safety: lets you review first)
- ‚ùå Does NOT build binaries locally (GitHub Actions does this)
- ‚ùå Does NOT create GitHub Release directly (GitHub Actions does this)

#### GitHub Actions Workflow

Triggered by pushing a version tag (`v*`), the workflow (`.github/workflows/updater-release.yml`):

1. **create-release** job:
   - Creates or retrieves GitHub Release

2. **build-tauri** job (parallel for each platform):
   - macOS: Universal binary (.dmg + .sig)
   - Windows: Installer (.msi + .sig)
   - Linux: AppImage (.AppImage + .sig)
   - Uploads all artifacts to GitHub Release

3. **generate-updater-metadata** job:
   - Generates `latest.json` with platform-specific download URLs
   - Includes signature verification data
   - Uploads to GitHub Release for auto-updater

#### Troubleshooting

**If build fails:**
- Check GitHub Actions logs: `https://github.com/<owner>/<repo>/actions`
- Common issues:
  - Rust compilation errors (check Cargo.toml dependencies)
  - Missing secrets (TAURI_SIGNING_PRIVATE_KEY, etc.)
  - Platform-specific build failures

**Version conflicts:**
- Always use the `release` script to avoid version mismatches
- If versions are out of sync, run the `sync-version` script manually:
  ```bash
  pnpm sync-version  # or npm run sync-version, yarn sync-version, bun run sync-version
  ```

## Known Issues and Limitations

### Platform Issues
- **Windows/Linux**: Not officially supported or tested
  - macOS is the only supported platform currently
  - Windows builds may compile but functionality not guaranteed
  - Path resolution issues likely on Windows (`~/.claude` expansion)
  - Linux builds not configured in Tauri
  - See "Platform and Deployment" section for details

### Missing Features (High Priority)
- **Search UI**: Backend fully implemented, frontend UI completely missing
  - Cannot search across conversations despite README claim
  - Backend command `search_messages` exists and works
  - Store actions ready but no UI components
  - See "Missing Features and Implementation Gaps" section for details

- **Session Navigation**: Limited discovery capabilities
  - No filtering or sorting options in ProjectTree
  - No search within sessions list
  - No recently viewed history
  - No bookmarks/favorites

### Performance Issues
- **Initial Load**: Large conversation histories (1000+ messages) slow to load
  - First session load reads entire JSONL file
  - Pagination helps but initial parse is still slow
  - No indexing or caching layer

- **Memory Usage**: All messages loaded into memory
  - Virtual scrolling helps with rendering
  - But full message list still in state
  - Can cause issues with very large sessions (10k+ messages)

### Content Rendering Gaps
- **Thinking Blocks**: Render as plain text, no dedicated UI
  - `type: "thinking"` content exists in data
  - No syntax highlighting or collapsible sections
  - Mixed with regular text in display

- **Images**: Data structure supports it, no renderer
  - `isImage` flag exists in tool results
  - No image display component implemented
  - Base64 images in JSONL not decoded/shown

- **MCP Results**: Basic rendering only
  - MCP (Model Context Protocol) tool results exist
  - No specialized visualization for MCP responses
  - Shown as raw JSON currently

### Testing Coverage
- **Unit Tests**: Minimal coverage
  - Vitest configured but barely used
  - Opportunity for contribution

- **E2E Tests**: Comprehensive Playwright test suite ‚úÖ
  - App initialization and startup
  - Project and session navigation
  - View switching (messages, analytics, tokens)
  - Theme management (light/dark)
  - Language switching (5 languages)
  - Settings interactions
  - Keyboard navigation basics
  - **Missing E2E coverage**:
    - Message rendering details
    - Analytics visualizations
    - Token statistics display
    - Error scenarios
    - Update system
    - Search functionality (when UI added)

### Auto-Update System
- **Beta Status**: Update system still being tested
  - Manual download may be safer
  - Signature verification works but edge cases untested
  - Force update mechanism not fully validated

### Data Limitations
- **Read-Only**: Cannot edit or delete conversations
  - App only reads JSONL files
  - No write capability to add notes/tags
  - No export functionality besides raw JSONL

### Internationalization
- **Partial Coverage**: Some UI strings not internationalized
  - Error messages often English-only
  - Tool result labels may not translate
  - Date/time formatting mostly internationalized

## Planned Enhancements

This section documents features that are planned or partially implemented, providing a roadmap for future development.

### üîç Search and Discovery (High Priority)

**Global Search UI** (Backend Ready ‚úÖ)
- Add search bar to Header or as dedicated view
- Create `SearchResults.tsx` component with result cards
- Show matching text with highlights
- Display project/session context for each result
- Allow clicking result to navigate to that session
- Add keyboard shortcuts (Cmd/Ctrl+K for search)

**Advanced Search Filters**
- Date range picker
- Project selector (multi-select)
- Message type filter (user/assistant/all)
- Tool usage filter (messages with specific tools)
- Error filter (messages with errors)
- Token usage thresholds

**Search Results Features**
- Pagination for large result sets
- Sort by relevance, date, project
- Export search results
- Save search queries for reuse

### üìä Enhanced Session Navigation

**Session List Improvements**
- Search/filter within ProjectTree
- Multiple sorting options:
  - Last modified (current default)
  - Message count
  - First created
  - Tool usage frequency
  - Token usage
- Quick jump to session by ID input
- Keyboard navigation in session list

**Session History and Bookmarks**
- Recently viewed sessions list (last 10)
- Favorite/bookmark sessions
- Pin important sessions to top
- Session tags/labels
- Custom session notes

**Session Grouping**
- Group by date (Today, Yesterday, This Week, etc.)
- Group by tool usage type
- Group by model used
- Custom grouping rules

### üñºÔ∏è Content Rendering Enhancements

**Thinking Blocks Visualization**
- Dedicated collapsible component for thinking content
- Syntax highlighting for code within thinking
- Copy thinking content separately
- Toggle visibility of thinking blocks globally

**Image Support**
- Decode and display base64 images from tool results
- Image zoom/lightbox functionality
- Image download capability
- Support for multiple image formats

**MCP Tool Results**
- Specialized renderers for different MCP tools
- Structured data visualization
- JSON tree view with expand/collapse
- Copy MCP results formatted

### üåê Platform Support

**Windows Support** (Partial ‚ö†Ô∏è)
- Test and fix path resolution on Windows
- Handle Windows-specific file permissions
- Test auto-updater on Windows
- Create Windows installer/MSI package
- Document Windows-specific setup

**Linux Support**
- Add Linux build targets to Tauri config
- Test on major distros (Ubuntu, Fedora, Arch)
- Create AppImage/Flatpak packages
- Handle different home directory structures
- Document Linux installation

### üíæ Data Management

**Export Functionality**
- Export conversations to Markdown
- Export to JSON with formatting
- Export search results
- Export analytics data to CSV
- Batch export multiple sessions

**Data Editing** (Read-Only Currently)
- Add custom notes to sessions
- Tag sessions with custom labels
- Mark sessions as favorites
- Archive old sessions (hide from view)

**Data Sync**
- Watch `~/.claude` for changes and auto-refresh
- Notification when new conversations added
- Automatic session list updates
- Handle concurrent updates safely

### üìà Analytics Enhancements

**More Visualizations**
- Token usage trends over time (line charts)
- Tool usage distribution (pie charts)
- Model usage comparison
- Cost estimation based on token usage
- Session duration patterns

**Comparative Analytics**
- Compare projects side-by-side
- Compare sessions within a project
- Time-based comparisons (this month vs last month)
- Model performance comparisons

**Export Analytics**
- Export charts as images
- Export data to CSV/Excel
- Generate usage reports
- Custom date ranges for reports

### üß™ Testing and Quality

**Test Coverage** (Partially Implemented ‚úÖ)
- Unit tests for all components (TODO)
- Integration tests for Tauri commands (TODO)
- E2E tests with Playwright (‚úÖ DONE - see `e2e/` directory)
- Visual regression testing (TODO)
- Performance benchmarks (TODO)

**Code Quality**
- Increase TypeScript strictness
- Add more ESLint rules
- Implement pre-commit hooks
- CI/CD pipeline improvements

### üé® UI/UX Improvements

**Accessibility**
- Full keyboard navigation
- Screen reader support
- High contrast mode
- Configurable font sizes
- ARIA labels for all interactive elements

**Customization**
- Custom color themes
- Configurable layout (sidebar width, etc.)
- Font family selection
- Code syntax theme selection
- Density options (compact/comfortable/spacious)

**Performance**
- Lazy loading for large sessions
- Background indexing for search
- Message content caching
- Optimistic UI updates
- Web worker for heavy computations

### üîê Security and Privacy

**Data Protection**
- Optional encryption for sensitive sessions
- Redact sensitive information in UI
- Export with anonymization option
- Secure deletion of conversations

### üì± Additional Features

**Command Palette** (VS Code style)
- Quick actions with Cmd/Ctrl+Shift+P
- Navigate to sessions
- Switch projects
- Toggle views
- Run analytics

**Workspace Management**
- Multiple `~/.claude` directory support
- Profile switching
- Workspace-specific settings
- Import/export workspace configurations

**Integration**
- Share conversations via links
- Integration with note-taking apps
- Export to popular formats (Notion, Obsidian, etc.)
- API for external tools

## Contributing

When implementing any of the planned enhancements:
1. Check if backend functionality already exists (e.g., search)
2. Review existing patterns in similar components
3. Add TypeScript types to `src/types/index.ts`
4. Add i18n translations for all UI strings
5. Update this CLAUDE.md with implementation details
6. Add tests for new functionality